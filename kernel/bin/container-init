#!/bin/bash

function init {

	service ssh start

	# [[ "`hostname`" == "nat-master" ]] && myvnc >/dev/null 2>&1 &

	while true; do ping docklet-cloud -c 1 -w 2 && break; done

	LOGS="/nfs/.docklet/logs"
	# [[ -e "/etc/rc.local" ]] && /etc/rc.local >/dev/null 2>&1 || true

	ssh 0.0.0.0 "cd /nfs/.tmp ; \
		while [[ ! -e ___package___ ]]; do sleep 1s; done ; \
		7z x ___package___ ; \
		while [[ ! -e main ]]; do sleep 1s; done ; \
		chmod a+x main ; \
		mkdir -p ${LOGS} ; rm -f ${LOGS}/dl-cluster.std{out,err} ; \
		./main >> ${LOGS}/dl-cluster.stdout 2>> ${LOGS}/dl-cluster.stderr ; \
		docklet remove"
}

init && exit

